#!/usr/bin/env node

const http = require('http')
const WebSocketServer = require('websocket')
  .server
const static = require('node-static')
const startSearh = require('../lib/server/start-search')

const PORT = process.env.PORT || 3000
const file = new static.Server(`${__dirname}/../public`)
const httpServer = http.createServer((req, res) => {
  req.addListener('end', () => file.serve(req, res))
    .resume()
})
const wsServer = new WebSocketServer({
  httpServer
})

httpServer.listen(PORT, () => console.log(`Server running at port:${PORT}`))
wsServer.on('request', (request) => {
  const connection = request.accept(null, request.origin)
  connection.on('message', (message) => {
    if (message.type === 'utf8') {
      startSearh(message.utf8Data, connection)
    }
  })
})
