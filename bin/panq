#!/usr/bin/env node

const PageStream = require('../lib/page-stream')
const RecentItemsStream = require('../lib/recent-items-stream')
const FetchPageRankStream = require('../lib/fetch-page-rank-stream')
const HasPageRankStream = require('../lib/has-page-rank-stream')
const CalculatePageRankStream = require('../lib/calculate-page-rank-stream')
const templateStream = require('../lib/template-stream')
const LimitStream = require('../lib/limit-stream')
const journal = require('../lib/journal')

const TAG = process.argv[2] || ''
const pageStream = new PageStream(TAG)
const recentItemsStream = new RecentItemsStream(pageStream, new Set())
const fetchPageRankStream = new FetchPageRankStream(journal.itemMap)
const limitStream = new LimitStream(recentItemsStream, fetchPageRankStream, 30)

const pageRankStream = pageStream
  .pipe(recentItemsStream)
  .pipe(fetchPageRankStream)
  .pipe(new HasPageRankStream())
  .pipe(new CalculatePageRankStream())
  .pipe(templateStream)

pageRankStream.pipe(limitStream)
pageRankStream.pipe(process.stdout)
