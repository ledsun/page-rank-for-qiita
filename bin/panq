#!/usr/bin/env node

const PageStream = require('../lib/page-stream')
const RecentItemsStream = require('../lib/recent-items-stream')
const FetchItemAttributesStream = require('../lib/fetch-item-attributes-stream')
const HasPageRankStream = require('../lib/has-page-rank-stream')
const CalculatePageRankStream = require('../lib/calculate-page-rank-stream')
const templateStream = require('../lib/cli/template-stream')
const LimitStream = require('../lib/limit-stream')
const journal = require('../lib/journal')

const TAG = process.argv[2] || ''
const pageStream = new PageStream(TAG)
const recentItemsStream = new RecentItemsStream(pageStream, new Set())
const fetchItemAttributesStream = new FetchItemAttributesStream(journal)
const limitStream = new LimitStream(recentItemsStream, fetchItemAttributesStream, 30)

const pageRankStream = pageStream
  .pipe(recentItemsStream)
  .pipe(fetchItemAttributesStream)
  .pipe(new CalculatePageRankStream())
  .pipe(new HasPageRankStream())
  .pipe(templateStream)

pageRankStream.pipe(limitStream)
pageRankStream.pipe(process.stdout)
